---

file:
  {{ clickhouse_data_directory }}:
    owner: {{ clickhouse_user }}
    group: {{ clickhouse_group }}
    exists: true
    filetype: directory
  {{ clickhouse_config_directory }}:
    owner: {{ clickhouse_user }}
    group: {{ clickhouse_group }}
    exists: true
    filetype: directory
  {{ clickhouse_log_directory }}:
    owner: {{ clickhouse_user }}
    group: {{ clickhouse_group }}
    exists: true
    filetype: directory
  {{ clickhouse_tmp_directory }}:
    owner: {{ clickhouse_user }}
    group: {{ clickhouse_group }}
    exists: true
    filetype: directory
  {{ clickhouse_config_directory }}/{{ clickhouse_config_file_name }}:
    owner: {{ clickhouse_user }}
    group: {{ clickhouse_group }}
    exists: true
    filetype: file
  {{ clickhouse_config_directory }}/{{ clickhouse_users_file_name }}:
    owner: {{ clickhouse_user }}
    group: {{ clickhouse_group }}
    exists: true
    filetype: file

service:
  {{ clickhouse_service }}:
    enabled: true
    running: true 

port:
  tcp:{{ clickhouse_tcp_port }}:
    listening: true

user:
  {{ clickhouse_user }}:
    exists: true
    groups:
      - {{ clickhouse_group }}
    shell: /usr/sbin/nologin

group:
  {{ clickhouse_group }}:
    exists: true

command:
  clickhouse-server_version:
    exit-status: 0
    exec: "clickhouse-server --version"
    stdout:
      - "{{ clickhouse_version }}"
    stderr: []
    timeout: 10000
    skip: false
  clickhouse-client_version:
    exit-status: 0
    exec: "clickhouse-client --version"
    stdout:
      - "{{ clickhouse_version }}"
    stderr: []
    timeout: 10000
    skip: false

http:
  http://localhost:8123?query=SHOW+USERS:
    status: 200
    timeout: 10000
    body: ["admin","default","readonly","Bunta","Takumi"]
    username: {{ clickhouse_admin_user }}
    password: {{ clickhouse_admin_password }}
    skip: false
  http://localhost:8123?query=SHOW+DATABASES:
    status: 200
    timeout: 10000
    body: ["system","default","ProjectD","ex_racing","racing"]
    username: {{ clickhouse_admin_user }}
    password: {{ clickhouse_admin_password }}
    skip: false
  http://localhost:8123?query=SHOW+GRANTS+FOR+Bunta:
    status: 200
    timeout: 10000
    body: 
      - "GRANT CREATE TEMPORARY TABLE, KILL QUERY, MOVE PARTITION BETWEEN SHARDS, SYSTEM SHUTDOWN, SYSTEM DROP CACHE, SYSTEM RELOAD, SYSTEM RESTART DISK, SYSTEM FLUSH LOGS, SYSTEM THREAD FUZZER, INTROSPECTION, SOURCES ON *.* TO Bunta"
      - "GRANT SHOW DICTIONARIES, CREATE DICTIONARY, DROP DICTIONARY, dictGet ON `<no_database>`.* TO Bunta"
      - "GRANT SHOW, SELECT, INSERT, ALTER, CREATE DATABASE, CREATE TABLE, CREATE VIEW, CREATE DICTIONARY, CREATE FUNCTION, DROP, TRUNCATE, OPTIMIZE, SYSTEM MERGES, SYSTEM TTL MERGES, SYSTEM FETCHES, SYSTEM MOVES, SYSTEM SENDS, SYSTEM REPLICATION QUEUES, SYSTEM DROP REPLICA, SYSTEM SYNC REPLICA, SYSTEM RESTART REPLICA, SYSTEM RESTORE REPLICA, SYSTEM FLUSH DISTRIBUTED, dictGet ON ex_racing.* TO Bunta"
      
    username: {{ clickhouse_admin_user }}
    password: {{ clickhouse_admin_password }}
    skip: false
  http://localhost:8123?query=SHOW+GRANTS+FOR+Takumi:
    status: 200
    timeout: 10000
    body: 
      - "GRANT projectd_members, tofu_shop TO Takumi"
    username: {{ clickhouse_admin_user }}
    password: {{ clickhouse_admin_password }}
    skip: false
